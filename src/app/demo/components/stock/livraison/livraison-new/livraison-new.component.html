<div class="card">
  <p-toast></p-toast>

  <div class="grid grid-nogutter">
    <!-- Titre -->
    <div class="col-12 px-4 mt-4 md:mt-6 md:px-6">
      <span class="text-900 block font-bold text-xl">Créer une livraison</span>
      <p-message *ngIf="errorMessage" severity="error" [text]="errorMessage"></p-message>
    </div>

    <div class="col-12 lg:col-10 h-full px-4 py-4 md:px-6">

      <!-- Livreur -->
      <div class="field mb-4">
        <label class="text-800 text-m block font-normal mb-2">Livreur</label>
        <input
          pInputText
          type="text"
          class="w-full"
          [value]="selectedLivreur?.nom_complet"
          readonly
        />
      </div>

      <!-- Client -->
      <div class="field mb-4">
        <label class="text-800 text-m block font-normal mb-2">Client à livrer</label>
        <p-dropdown
          [options]="contacts"
          [(ngModel)]="selectedClient"
          optionLabel="nom_complet"
          placeholder="Sélectionner un client"
          [filter]="true"
          filterBy="nom_complet telephone"
          [showClear]="true"
          appendTo="body"
          styleClass="w-full"
        >
          <ng-template let-client pTemplate="selectedItem">
            <div *ngIf="client" class="flex flex-column">
              <div class="font-medium">{{ client.nom_complet }}</div>
              <small class="text-500">{{ client.telephone }}</small>
            </div>
          </ng-template>
          <ng-template let-client pTemplate="item">
            <div class="flex flex-column">
              <div class="font-medium">{{ client.nom_complet }}</div>
              <small class="text-500">{{ client.telephone }}</small>
            </div>
          </ng-template>
        </p-dropdown>
        <div *ngIf="apiErrors?.['client_id']" class="text-red-500 text-sm mt-1">
          {{ apiErrors['client_id'][0] }}
        </div>
      </div>

      <!-- Table des produits -->
      <div class="overflow-auto">
        <table class="w-full text-sm text-left">
          <thead class="text-xs text-gray-700 border-b">
            <tr>
              <th class="py-2">Produit</th>
              <th class="py-2">Qté Restante</th>
              <th class="py-2">Prix unitaire</th>
              <th class="py-2">Sous-total</th>
              <th class="py-2"></th>
            </tr>
          </thead>
          <tbody>
            <tr *ngFor="let ligne of lignes; let i = index" class="border-b">

              <!-- Produit -->
              <td class="py-2">
                <p-dropdown
                  [options]="produits"
                  [(ngModel)]="ligne.produit"
                  optionLabel="nom"
                  placeholder="Sélectionner un produit"
                  appendTo="body"
                  (onChange)="onProduitChange(i)"
                  styleClass="w-full"
                ></p-dropdown>
                <div *ngIf="apiErrors?.['lignes.' + i + '.produit_id']" class="text-red-500 text-xs mt-1">
                  {{ apiErrors['lignes.' + i + '.produit_id'][0] }}
                </div>
              </td>

              <!-- Quantité Restante (affichée) -->
              <td class="py-2">
                <input
                  type="number"
                  class="p-inputtext w-full"
                  [value]="ligne.quantiteRestante"
                  readonly
                />
              </td>

              <!-- Prix unitaire -->
              <td class="py-2">
                <input
                  type="number"
                  class="p-inputtext w-full"
                  [(ngModel)]="ligne.prix_vente"
                  min="0"
                />
              </td>

              <!-- Sous-total -->
              <td class="py-2">
                {{ ligne.quantiteRestante * ligne.prix_vente | number:'1.0-0' }} GNF
              </td>

              <!-- Supprimer ligne -->
              <td class="py-2 text-right">
                <button
                  pButton
                  icon="pi pi-trash"
                  class="p-button-danger p-button-sm"
                  (click)="supprimerLigne(i)"
                ></button>
              </td>
            </tr>
          </tbody>
        </table>
      </div>

      <!-- Boutons -->
      <div class="col-12 flex flex-column lg:flex-row justify-content-center align-items-center lg:justify-content-end my-6">
        <button
          pButton
          pRipple
          class="p-button-secondary p-button-outlined mt-3 lg:mt-0 w-full lg:w-auto flex-order-2 lg:flex-order-1 lg:mr-4"
          label="Annuler"
          icon="pi pi-arrow-left"
          (click)="onGoToListeCommande()"
        ></button>

        <button
          pButton
          pRipple
          class="p-button-primary w-full lg:w-auto flex-order-1 lg:flex-order-2"
          label="Valider la commande"
          icon="pi pi-check"
          (click)="onSubmit()"
        ></button>
      </div>

    </div>
  </div>
</div>
