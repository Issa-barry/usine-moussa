<div class="grid">
  <div class="col-12">
    <div class="card px-6 py-6">
      <p-toast></p-toast>
      <p-confirmDialog></p-confirmDialog>

      <p-toolbar styleClass="mb-4">
        <ng-template pTemplate="left">
          <button
            pButton
            pRipple
            label="Nouvelle commande"
            icon="pi pi-plus"
            class="p-button-success mr-2"
            (click)="onGoToNewCommande()"
            aria-label="Créer une nouvelle commande">
          </button>
        </ng-template>

        <ng-template pTemplate="right">
          <!-- Filtre période -->
          <p-dropdown
            [options]="periodeOptions"
            [(ngModel)]="selectedPeriode"
            placeholder="Période"
            appendTo="body"
            (onChange)="onPeriodeChange()"
            inputId="filtrePeriode"
            aria-label="Filtrer par période">
          </p-dropdown>
        </ng-template>
      </p-toolbar>

      <p-table
        #dt
        [value]="loading ? skeletonRows : commandes"
        [lazy]="true"
        
        [paginator]="true"
        [rows]="perPage"
        [rowsPerPageOptions]="rowsPerPageOptions"
        [totalRecords]="meta?.total || 0"
        [showCurrentPageReport]="true"
        currentPageReportTemplate="{first} à {last} sur {totalRecords} commandes"
        dataKey="id"
        responsiveLayout="scroll"
        (onPage)="onPageChange($event)"
        styleClass="p-datatable-sm"
        [rowHover]="true">

        <ng-template pTemplate="caption">
          <div class="flex flex-column md:flex-row md:justify-content-between md:align-items-center gap-3">
            <h5 class="m-0">Liste des commandes</h5>

            <!-- Recherche serveur -->
            <span class="block mt-2 md:mt-0 p-input-icon-left w-full md:w-20rem">
              <i class="pi pi-search"></i>
              <input
                pInputText
                type="text"
                (input)="onGlobalFilter($event)"
                placeholder="Recherche..."
                aria-label="Recherche de commandes"
                class="w-full" />
            </span>
          </div>
        </ng-template>

        <ng-template pTemplate="header">
          <!-- <tr>
            <th style="width:3rem">
              <p-tableHeaderCheckbox aria-label="Sélectionner toutes les commandes"></p-tableHeaderCheckbox>
            </th>
            <th>N° Commande</th>
            <th>Livreur</th>
            <th class="text-right">Total</th>
            <th class="text-right">Qté commandée</th>
            <th class="text-right">Qté livrée</th>
            <th>Statut</th>
            <th style="width: 15rem;">Actions</th>
          </tr> -->
            <tr>
                        <th style="width: 3rem">
                            <p-tableHeaderCheckbox></p-tableHeaderCheckbox>
                        </th>
                        <th pSortableColumn="numero">N° Commande <p-sortIcon field="numero"></p-sortIcon></th>
                        <th pSortableColumn="contact?.nom_complet">Client <p-sortIcon field="contact?.nom_complet"></p-sortIcon></th>
                        <th>Total</th>
                        <th pSortableColumn="qte_total">Qté total <p-sortIcon field="qte_total"></p-sortIcon></th>
                        <th pSortableColumn="qte_livree">Livrée <p-sortIcon field="qte_livree"></p-sortIcon></th>
                        <th pSortableColumn="statut">Statut <p-sortIcon field="statut"></p-sortIcon></th>
                        <th >Action </th>
                        <th></th>
                    </tr>
        </ng-template>

        <!-- Corps : 2 variantes -->
        <ng-template pTemplate="body" let-commande>
          <!-- Variante Skeleton pendant le chargement -->
          <tr *ngIf="loading">
            <td ><p-skeleton width="1.5rem" height="1.5rem" borderRadius="0.25rem"></p-skeleton></td>
            <td><p-skeleton width="9rem"></p-skeleton></td>
            <td><p-skeleton width="12rem"></p-skeleton></td>
            <td class="text-right"><p-skeleton width="6rem"></p-skeleton></td>
            <td class="text-right"><p-skeleton width="5rem"></p-skeleton></td>
            <td class="text-right"><p-skeleton width="5rem"></p-skeleton></td>
            <td><p-skeleton width="8rem" height="2rem" borderRadius="2rem"></p-skeleton></td>
            <td class="white-space-nowrap">
              <p-skeleton width="2rem" height="2rem" styleClass="mr-2" borderRadius="50%"></p-skeleton>
              <!-- <p-skeleton width="2rem" height="2rem" styleClass="mr-2" borderRadius="50%"></p-skeleton>
              <p-skeleton width="2rem" height="2rem" borderRadius="50%"></p-skeleton> -->
            </td>
          </tr>

          <!-- Variante réelle quand les données sont là -->
          <tr *ngIf="!loading" >
            <td >
              <p-tableCheckbox [value]="commande" [ariaLabel]="'Sélectionner la commande ' + commande.numero"></p-tableCheckbox>
            </td>

            <td class="white-space-nowrap" (click)="onGoToDetailCommande(commande)" style="cursor: pointer;">{{ commande.numero }}</td>
            <td (click)="onGoToDetailCommande(commande)" style="cursor: pointer;">{{ commande.contact?.nom_complet || '—' }}</td>

            <td class="white-space-nowrap" (click)="onGoToDetailCommande(commande)" style="cursor: pointer;">{{ commande.montant_total | number:'1.0-0' }} GNF</td>
            <td class="white-space-nowrap"(click)="onGoToDetailCommande(commande)" style="cursor: pointer;">{{ commande.qte_total }}</td>
            <td class="white-space-nowrap" (click)="onGoToDetailCommande(commande)" style="cursor: pointer;">{{ commande.qte_livree }}</td>

              <td (click)="onGoToDetailCommande(commande)" style="cursor: pointer;">
      <span class="status-badge"
            [ngClass]="'status-' + statusKey(commande.statut)">
        {{ getStatusLabel(commande.statut) }}
      </span>
    </td>


            <td class="white-space-nowrap">
              <!-- Voir -->
              <!-- <button
                pButton pRipple icon="pi pi-eye"
                class="p-button-rounded p-button-success mr-2"
                pTooltip="Voir la commande"
                tooltipPosition="top"
                (click)="onGoToDetailCommande(commande)">
              </button> -->

              <!-- Brouillon : valider -->
              <button
                *ngIf="commande.statut === 'brouillon'"
                pButton pRipple icon="pi pi-check"
                class="p-button-rounded p-button-info mr-2"
                pTooltip="Valider la commande"
                tooltipPosition="top"
                (click)="validerCommande(commande)">
              </button>

              <!-- Livraison en cours -->
              <button
                *ngIf="commande.statut === 'livraison_en_cours'"
                pButton pRipple icon="pi pi-truck"
                class="p-button-rounded p-button-warning mr-2"
                pTooltip="Voir / enregistrer la livraison"
                tooltipPosition="top"
                (click)="onGoToLivraisonNew(commande)">
              </button>

              <!-- Livré -->
              <button
                *ngIf="commande.statut === 'livré'"
                pButton pRipple icon="pi pi-truck"
                class="p-button-rounded p-button-success mr-2"
                pTooltip="Détails de la livraison"
                tooltipPosition="top"
                (click)="onGoToLivraisonDetail(commande)">
              </button>

              <!-- Payé -->
              <button
                *ngIf="commande.statut === 'payé'"
                pButton pRipple icon="pi pi-credit-card"
                class="p-button-rounded p-button-success mr-2"
                pTooltip="Commande payée"
                tooltipPosition="top"
                disabled>
              </button>

              <!-- Annulé -->
              <button
                *ngIf="commande.statut === 'annulé'"
                pButton pRipple icon="pi pi-ban"
                class="p-button-rounded p-button-secondary mr-2"
                pTooltip="Commande annulée"
                tooltipPosition="top"
                disabled>
              </button>

              <!-- Clôturé -->
              <button
                *ngIf="commande.statut === 'cloturé'"
                pButton
                pRipple
                icon="pi pi-lock"
                class="p-button-rounded p-button-secondary mr-2"
                pTooltip="Commande clôturée"
                tooltipPosition="top"
                disabled>
              </button>
            </td>
          </tr>
        </ng-template>

        <!-- Message vide uniquement si pas en chargement -->
        <ng-template pTemplate="emptymessage">
          <tr *ngIf="!loading">
            <td colspan="8" class="text-center py-6 text-600">Aucune commande trouvée.</td>
          </tr>
        </ng-template>
      </p-table>

      <!-- Dialog détail (inchangé) -->
      <p-dialog
        [(visible)]="commandeDetailDialog"
        [style]="{ width: '640px' }"
        [header]="'Commande n° : ' + (selectedCommande?.numero || '')"
        [modal]="true"
        class="p-fluid">

        <ng-template pTemplate="content">
          <div class="grid">
            <div class="col-12 md:col-4">
              <label class="block font-medium mb-1">Statut</label>
             <span class="status-badge"
      [ngClass]="'status-' + statusKey(selectedCommande?.statut)">
  {{ getStatusLabel(selectedCommande?.statut) }}
</span>

            </div>

            <div class="col-12 md:col-4">
              <label class="block font-medium mb-1">Livreur</label>
              <div>{{ selectedCommande?.contact?.nom_complet || '—' }}</div>
            </div>

            <div class="col-12 md:col-4">
              <label class="block font-medium mb-1">Date</label>
              <div>{{ selectedCommande?.created_at | date:'medium' }}</div>
            </div>
          </div>

          <hr class="my-3" />

          <div class="grid mb-3">
            <div class="col-12 md:col-4">
              <label class="block font-medium mb-1">Total</label>
              <div>{{ selectedCommande?.montant_total | number:'1.0-0' }} GNF</div>
            </div>
            <div class="col-12 md:col-4">
              <label class="block font-medium mb-1">Qté commandée</label>
              <div>{{ selectedCommande?.qte_total }}</div>
            </div>
            <div class="col-12 md:col-4">
              <label class="block font-medium mb-1">Qté livrée</label>
              <div>{{ selectedCommande?.qte_livree }}</div>
            </div>
          </div>

          <div class="field">
            <label class="block font-medium mb-2">Produits commandés</label>
            <p-table [value]="selectedLignes" responsiveLayout="scroll" styleClass="p-datatable-sm">
              <ng-template pTemplate="header">
                <tr>
                  <th>Produit</th>
                  <th class="text-right">Quantité</th>
                  <th class="text-right">Prix unitaire</th>
                  <th class="text-right">Sous-total</th>
                </tr>
              </ng-template>
              <ng-template pTemplate="body" let-ligne>
                <tr>
                  <td>{{ ligne.produit?.nom }}</td>
                  <td class="text-right">{{ ligne.quantite_commandee }}</td>
                  <td class="text-right">{{ ligne.prix_vente | number:'1.0-0' }} GNF</td>
                  <td class="text-right">{{ (ligne.quantite_commandee * ligne.prix_vente) | number:'1.0-0' }} GNF</td>
                </tr>
              </ng-template>
              <ng-template pTemplate="emptymessage">
                <tr>
                  <td colspan="4" class="text-center py-4 text-600">Aucune ligne.</td>
                </tr>
              </ng-template>
            </p-table>
          </div>
        </ng-template>

        <ng-template pTemplate="footer">
          <button
            pButton pRipple label="Fermer" icon="pi pi-times"
            class="p-button-text"
            (click)="commandeDetailDialog = false">
          </button>
          <button
            pButton pRipple label="Détail" icon="pi pi-pencil"
            class="p-button-text"
            (click)="onGoToDetailCommande(selectedCommande!)">
          </button>
        </ng-template>
      </p-dialog>
    </div>
  </div>
</div>
